<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFåˆ†æåŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-input-label:hover {
            background: #2980b9;
        }
        #pdfFile {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-name {
            margin-left: 10px;
            font-style: italic;
        }
        .pdf-status {
            color: #27ae60;
            margin-top: 10px;
            font-style: italic;
            display: none;
        }
        .error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* èŠå¤©æ¡†æ ·å¼ */
        .chat-container {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        .chat-header {
            background: #3498db;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            position: relative;
        }
        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            margin-left: auto;
            text-align: right;
        }
        .user-message .message-bubble {
            background: #3498db;
            color: white;
            border-radius: 15px 15px 0 15px;
            float: right;
        }
        .bot-message .message-bubble {
            background: #e1e1e1;
            color: #333;
            border-radius: 15px 15px 15px 0;
            float: left;
        }
        .message::after {
            content: "";
            display: table;
            clear: both;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background: white;
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        #sendButton {
            margin-left: 10px;
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        #sendButton:hover {
            background: #2980b9;
        }
        .chat-loading {
            text-align: center;
            padding: 10px;
            display: none;
        }
        .chat-loading-dots {
            display: inline-block;
        }
        .chat-loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
            margin: 0 3px;
            animation: dots 1.5s infinite;
        }
        .chat-loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .chat-loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes dots {
            0%, 80%, 100% { transform: scale(0); opacity: 0; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDFåˆ†æåŠ©æ‰‹</h1>
        
        <div class="form-group">
            <div class="file-input-container">
                <label class="file-input-label">é€‰æ‹©PDFæ–‡ä»¶</label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>
            <span class="file-name" id="fileName"></span>
            <div class="pdf-status" id="pdfStatus"></div>
        </div>
        
        <div class="error" id="errorMessage"></div>
        
        <!-- æ·»åŠ ä¸€ä¸ªæ›´æ˜æ˜¾çš„æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
        <div class="form-group">
            <div class="mode-info-container">
                <div class="mode-title">ä½¿ç”¨æ¨¡å¼è¯´æ˜</div>
                <div class="mode-list">
                    <div style="margin-bottom:5px"><b>æ¨¡å¼ä¸€ (é»˜è®¤)ï¼šé€šè¿‡æœåŠ¡å™¨</b> - æœåŠ¡å™¨å¤„ç†PDFå’Œé—®é¢˜ï¼Œéœ€è¦æœåŠ¡å™¨è¿è¡Œ</div>
                    <div style="margin-bottom:5px"><b>æ¨¡å¼äºŒï¼šç›´æ¥ä½¿ç”¨Kimi</b> - å‹¾é€‰èŠå¤©æ¡†é¡¶éƒ¨å·¦ä¾§çš„"ç›´æ¥ä½¿ç”¨Kimi"é€‰é¡¹ï¼Œå‰ç«¯ç›´æ¥è°ƒç”¨APIï¼Œæ— éœ€æœåŠ¡å™¨</div>
                </div>
            </div>
        </div>
        
        <!-- èŠå¤©ç•Œé¢ -->
        <div class="chat-container">
            <div class="chat-header">èŠå¤©å¯¹è¯</div>
            <div class="chat-messages" id="chatMessages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message bot-message">
                    <div class="message-bubble">
                        æ¬¢è¿ä½¿ç”¨PDFåˆ†æåŠ©æ‰‹ï¼æ‚¨å¯ä»¥ï¼š<br>1. ç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥é—®é¢˜è¿›è¡Œæé—®<br>2. ä¸Šä¼ PDFæ–‡ä»¶åæé—®ï¼Œè·å¾—åŸºäºPDFå†…å®¹çš„ç²¾å‡†å›ç­”
                    </div>
                </div>
            </div>
            <div class="chat-loading" id="chatLoading">
                <div class="chat-loading-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                <button id="sendButton">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let selectedPdfFile = null; // å­˜å‚¨é€‰æ‹©çš„PDFæ–‡ä»¶
        
        document.addEventListener('DOMContentLoaded', function() {
            const pdfFileInput = document.getElementById('pdfFile');
            const fileNameDisplay = document.getElementById('fileName');
            const pdfStatus = document.getElementById('pdfStatus');
            const errorMessage = document.getElementById('errorMessage');
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const chatLoading = document.getElementById('chatLoading');
            
            // å®šä¹‰æœåŠ¡å™¨URL
            const serverUrl = 'http://localhost:3000';
            
            // æ·»åŠ è°ƒè¯•æ—¥å¿—åŠŸèƒ½
            const DEBUG = true; // è®¾ç½®ä¸ºfalseå¯ä»¥ç¦ç”¨æ‰€æœ‰è°ƒè¯•æ—¥å¿—
            
            function debugLog(...args) {
                if (DEBUG) {
                    console.log('[DEBUG]', ...args);
                }
            }
            
            // æ—¥å¿—åˆ†ç»„å‡½æ•°ï¼Œä¾¿äºåœ¨æ§åˆ¶å°ä¸­ç»„ç»‡æ—¥å¿—
            function debugGroup(groupName) {
                if (DEBUG) {
                    console.group(`[DEBUG] ${groupName}`);
                }
            }
            
            function debugGroupEnd() {
                if (DEBUG) {
                    console.groupEnd();
                }
            }
            
            // è®°å½•è¯·æ±‚/å“åº”å¯¹è±¡ï¼ˆå»é™¤é•¿æ•°æ®ï¼‰
            function logRequestResponse(obj, type = 'request') {
                if (!DEBUG) return;
                
                // åˆ›å»ºä¸€ä¸ªå…‹éš†å¯¹è±¡ä»¥é¿å…ä¿®æ”¹åŸå§‹å¯¹è±¡
                const clone = JSON.parse(JSON.stringify(obj));
                
                // å¦‚æœæ˜¯åŒ…å«æ–‡ä»¶çš„è¯·æ±‚ï¼Œæ›¿æ¢é•¿base64ä¸ºæ‘˜è¦ä¿¡æ¯
                if (clone.files && clone.files.length > 0) {
                    clone.files = clone.files.map(file => {
                        if (file.data && file.data.length > 100) {
                            return {
                                ...file,
                                data: `[Base64 data: ${file.data.length} chars]`,
                                data_preview: file.data.substring(0, 50) + '...'
                            };
                        }
                        return file;
                    });
                }
                
                // è®°å½•è¯·æ±‚/å“åº”å¯¹è±¡
                console.log(`[DEBUG] ${type.toUpperCase()}:`, clone);
                
                // è¿”å›å…‹éš†å¯¹è±¡ä»¥å…è®¸é“¾å¼è°ƒç”¨
                return clone;
            }
            
            // ä¿®æ”¹æ¬¢è¿æ¶ˆæ¯ï¼Œæ›´æ¸…æ™°åœ°è¡¨æ˜å¯ä»¥ç›´æ¥æé—®
            const welcomeMessage = document.querySelector('.bot-message .message-bubble');
            welcomeMessage.innerHTML = 'æ¬¢è¿ä½¿ç”¨PDFåˆ†æåŠ©æ‰‹ï¼æ‚¨å¯ä»¥ï¼š<br>1. ç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥é—®é¢˜è¿›è¡Œæé—®<br>2. ä¸Šä¼ PDFæ–‡ä»¶åæé—®ï¼Œè·å¾—åŸºäºPDFå†…å®¹çš„ç²¾å‡†å›ç­”';
            
            // æ·»åŠ ä¸€ä¸ªæ›´æ˜æ˜¾çš„æ¨¡å¼åˆ‡æ¢å¼€å…³
            const bigSwitchContainer = document.createElement('div');
            bigSwitchContainer.style.display = 'flex';
            bigSwitchContainer.style.alignItems = 'center';
            bigSwitchContainer.style.justifyContent = 'center';
            bigSwitchContainer.style.marginBottom = '15px';
            bigSwitchContainer.style.padding = '10px';
            bigSwitchContainer.style.backgroundColor = '#e8f4fc';
            bigSwitchContainer.style.borderRadius = '5px';
            bigSwitchContainer.style.border = '1px solid #3498db';
            
            const bigModeSwitch = document.createElement('div');
            bigModeSwitch.style.display = 'flex';
            bigModeSwitch.style.alignItems = 'center';
            
            const bigDirectKimiCheckbox = document.createElement('input');
            bigDirectKimiCheckbox.type = 'checkbox';
            bigDirectKimiCheckbox.id = 'bigDirectKimiCheckbox';
            bigDirectKimiCheckbox.style.width = '20px';
            bigDirectKimiCheckbox.style.height = '20px';
            bigDirectKimiCheckbox.style.marginRight = '10px';
            
            const bigDirectKimiLabel = document.createElement('label');
            bigDirectKimiLabel.htmlFor = 'bigDirectKimiCheckbox';
            bigDirectKimiLabel.innerHTML = '<b>ç›´æ¥ä½¿ç”¨Kimiæ¨¡å¼</b>ï¼ˆæ— éœ€å¯åŠ¨æœåŠ¡å™¨ï¼Œç›´æ¥é€šè¿‡æµè§ˆå™¨è°ƒç”¨Kimi APIï¼‰';
            bigDirectKimiLabel.style.fontSize = '16px';
            bigDirectKimiLabel.style.color = '#333';
            
            bigModeSwitch.appendChild(bigDirectKimiCheckbox);
            bigModeSwitch.appendChild(bigDirectKimiLabel);
            bigSwitchContainer.appendChild(bigModeSwitch);
            
            // æ’å…¥åˆ°h1åé¢
            document.querySelector('h1').after(bigSwitchContainer);
            
            // æ·»åŠ æ¨¡å¼é€‰æ‹©æç¤ºåŒºåŸŸ
            const modeInfoContainer = document.createElement('div');
            modeInfoContainer.style.marginTop = '15px';
            modeInfoContainer.style.marginBottom = '15px';
            modeInfoContainer.style.padding = '10px';
            modeInfoContainer.style.backgroundColor = '#f8f9fa';
            modeInfoContainer.style.borderRadius = '5px';
            modeInfoContainer.style.border = '1px solid #ddd';
            modeInfoContainer.style.fontSize = '14px';
            
            const modeTitle = document.createElement('div');
            modeTitle.style.fontWeight = 'bold';
            modeTitle.style.marginBottom = '8px';
            modeTitle.textContent = 'ä½¿ç”¨æ¨¡å¼è¯´æ˜';
            
            const modeList = document.createElement('div');
            modeList.innerHTML = `
                <div style="margin-bottom:5px"><b>æ¨¡å¼ä¸€ (é»˜è®¤)ï¼šé€šè¿‡æœåŠ¡å™¨</b> - æœåŠ¡å™¨å¤„ç†PDFå’Œé—®é¢˜ï¼Œéœ€è¦æœåŠ¡å™¨è¿è¡Œ</div>
                <div style="margin-bottom:5px"><b>æ¨¡å¼äºŒï¼šç›´æ¥ä½¿ç”¨Kimi</b> - å‹¾é€‰èŠå¤©æ¡†é¡¶éƒ¨å·¦ä¾§çš„"ç›´æ¥ä½¿ç”¨Kimi"é€‰é¡¹ï¼Œå‰ç«¯ç›´æ¥è°ƒç”¨APIï¼Œæ— éœ€æœåŠ¡å™¨</div>
            `;
            
            modeInfoContainer.appendChild(modeTitle);
            modeInfoContainer.appendChild(modeList);
            
            // æ’å…¥åˆ°form-groupåé¢
            document.querySelector('.form-group').after(modeInfoContainer);
            
            // åœ¨UIä¸Šæ˜¾ç¤ºå½“å‰ä¼šè¯çŠ¶æ€
            function updateSessionStatus() {
                // åˆ›å»ºæˆ–è·å–çŠ¶æ€æŒ‡ç¤ºå™¨
                let statusIndicator = document.getElementById('sessionStatusIndicator');
                if (!statusIndicator) {
                    statusIndicator = document.createElement('div');
                    statusIndicator.id = 'sessionStatusIndicator';
                    statusIndicator.style.position = 'absolute';
                    statusIndicator.style.top = '10px';
                    statusIndicator.style.right = '10px';
                    statusIndicator.style.padding = '5px 10px';
                    statusIndicator.style.borderRadius = '4px';
                    statusIndicator.style.fontSize = '12px';
                    statusIndicator.style.fontWeight = 'bold';
                    document.querySelector('.chat-header').appendChild(statusIndicator);
                }
                
                if (sessionId && selectedPdfFile) {
                    // æœ‰ä¼šè¯IDå’ŒPDFæ–‡ä»¶
                    statusIndicator.textContent = 'ğŸ“„ PDFæ¨¡å¼';
                    statusIndicator.style.backgroundColor = '#27ae60';
                    statusIndicator.style.color = 'white';
                } else if (sessionId) {
                    // åªæœ‰ä¼šè¯IDï¼Œæ²¡æœ‰PDF
                    statusIndicator.textContent = 'ğŸ’¬ ä¸€èˆ¬èŠå¤©æ¨¡å¼';
                    statusIndicator.style.backgroundColor = '#3498db';
                    statusIndicator.style.color = 'white';
                } else {
                    // æ²¡æœ‰ä¼šè¯
                    statusIndicator.textContent = 'âšª æœªå¼€å§‹ä¼šè¯';
                    statusIndicator.style.backgroundColor = '#95a5a6';
                    statusIndicator.style.color = 'white';
                }
            }
            
            // åˆå§‹æ›´æ–°çŠ¶æ€
            updateSessionStatus();
            
            // ç›‘å¬æ–‡ä»¶é€‰æ‹©
            pdfFileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (file.type !== 'application/pdf') {
                        showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„PDFæ–‡ä»¶');
                        selectedPdfFile = null;
                        fileNameDisplay.textContent = '';
                        pdfStatus.style.display = 'none';
                        return;
                    }
                    
                    // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
                    selectedPdfFile = file;
                    fileNameDisplay.textContent = file.name;
                    pdfStatus.textContent = 'å·²é€‰æ‹©PDFæ–‡ä»¶ï¼Œè¯·åœ¨èŠå¤©æ¡†ä¸­æé—®';
                    pdfStatus.style.display = 'block';
                    errorMessage.style.display = 'none';
                } else {
                    selectedPdfFile = null;
                    fileNameDisplay.textContent = '';
                    pdfStatus.style.display = 'none';
                }
            });
            
            // å‘é€èŠå¤©æ¶ˆæ¯
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;
                
                debugGroup('å‘é€æ–°æ¶ˆæ¯');
                debugLog('ç”¨æˆ·è¾“å…¥:', message);
                debugLog('å½“å‰ä¼šè¯çŠ¶æ€:', { 
                    sessionId, 
                    hasPdf: !!selectedPdfFile, 
                    directMode: bigDirectKimiCheckbox.checked 
                });
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
                addMessage(message, 'user');
                
                // æ¸…ç©ºè¾“å…¥
                messageInput.value = '';
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                chatLoading.style.display = 'block';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰PDFæ–‡ä»¶ï¼ˆæœªä¸Šä¼ è¿‡ï¼‰æˆ–å·²æœ‰ä¼šè¯IDï¼ˆå·²ä¸Šä¼ è¿‡ï¼‰
                if (selectedPdfFile && !sessionId) {
                    debugLog('é¦–æ¬¡å‘é€PDFå’Œé—®é¢˜');
                    // æœ‰PDFæ–‡ä»¶ä½†æ²¡æœ‰ä¼šè¯IDï¼Œé¦–æ¬¡å‘é€PDFå’Œé—®é¢˜
                    sendPdfWithQuestion(selectedPdfFile, message);
                } else {
                    debugLog('å‘é€å¸¸è§„èŠå¤©æ¶ˆæ¯');
                    // æ²¡æœ‰PDFæ–‡ä»¶æˆ–å·²æœ‰ä¼šè¯IDï¼Œåªå‘é€é—®é¢˜
                    // ä¼šè¯IDä¿è¯äº†å¯¹è¯ä¸Šä¸‹æ–‡ä¸­åŒ…å«ä¹‹å‰ä¸Šä¼ çš„PDFä¿¡æ¯
                    sendChatMessage(message);
                }
                debugGroupEnd();
            }
            
            // æ·»åŠ ç›´è¿Kimié€‰é¡¹
            const headerElement = document.querySelector('.chat-header');
            const directKimiContainer = document.createElement('div');
            directKimiContainer.style.position = 'absolute';
            directKimiContainer.style.left = '10px';
            directKimiContainer.style.display = 'flex';
            directKimiContainer.style.alignItems = 'center';
            
            const directKimiCheckbox = document.createElement('input');
            directKimiCheckbox.type = 'checkbox';
            directKimiCheckbox.id = 'directKimiCheckbox';
            directKimiCheckbox.style.marginRight = '5px';
            
            const directKimiLabel = document.createElement('label');
            directKimiLabel.htmlFor = 'directKimiCheckbox';
            directKimiLabel.textContent = 'ç›´æ¥ä½¿ç”¨Kimi';
            directKimiLabel.style.fontSize = '12px';
            directKimiLabel.style.color = 'white';
            
            directKimiContainer.appendChild(directKimiCheckbox);
            directKimiContainer.appendChild(directKimiLabel);
            headerElement.appendChild(directKimiContainer);
            
            // åœ¨APIå¯†é’¥è¾“å…¥
            const apiKeyContainer = document.createElement('div');
            apiKeyContainer.style.display = 'none';
            apiKeyContainer.style.marginTop = '10px';
            apiKeyContainer.style.padding = '10px';
            apiKeyContainer.style.backgroundColor = '#f8f9fa';
            apiKeyContainer.style.borderRadius = '5px';
            
            const apiKeyInput = document.createElement('input');
            apiKeyInput.type = 'text';
            apiKeyInput.id = 'kimiApiKey';
            apiKeyInput.placeholder = 'è¾“å…¥æ‚¨çš„Kimi APIå¯†é’¥';
            apiKeyInput.style.width = '100%';
            apiKeyInput.style.padding = '8px';
            apiKeyInput.style.border = '1px solid #ddd';
            apiKeyInput.style.borderRadius = '4px';
            apiKeyInput.value = 'sk-gMw8OXgmJaCiaQgwqfaPrzCZED06OiRX2fMe4AT9UF2hVzNz'; // é»˜è®¤å€¼ï¼Œç”¨æˆ·å¯ä»¥ä¿®æ”¹
            
            apiKeyContainer.appendChild(apiKeyInput);
            
            // å°†APIå¯†é’¥è¾“å…¥æ¡†æ”¾åœ¨å¤§å¼€å…³ä¸‹é¢
            bigSwitchContainer.appendChild(apiKeyContainer);
            
            // ç›‘å¬å¤§å¼€å…³å˜åŒ–
            bigDirectKimiCheckbox.addEventListener('change', function() {
                apiKeyContainer.style.display = this.checked ? 'block' : 'none';
                // åŒæ­¥ä¸¤ä¸ªå¼€å…³çŠ¶æ€
                if (directKimiCheckbox) {
                    directKimiCheckbox.checked = this.checked;
                }
            });
            
            // åŒæ­¥ä¸¤ä¸ªå¤é€‰æ¡†çš„çŠ¶æ€
            directKimiCheckbox.addEventListener('change', function() {
                bigDirectKimiCheckbox.checked = this.checked;
                apiKeyContainer.style.display = this.checked ? 'block' : 'none';
            });
            
            // ä¿®æ”¹å‘é€PDFå’Œé—®é¢˜çš„å‡½æ•°ï¼Œæ”¯æŒç›´æ¥è°ƒç”¨Kimi API
            function sendPdfWithQuestion(pdfFile, question) {
                debugGroup('PDFä¸Šä¼ å’Œé—®é¢˜å¤„ç†');
                debugLog('PDFæ–‡ä»¶ä¿¡æ¯:', { 
                    name: pdfFile.name, 
                    size: pdfFile.size, 
                    type: pdfFile.type 
                });
                debugLog('é—®é¢˜:', question);
                debugLog('æ¨¡å¼:', bigDirectKimiCheckbox.checked ? 'ç›´æ¥ä½¿ç”¨Kimi' : 'é€šè¿‡æœåŠ¡å™¨');
                
                // æ£€æŸ¥æ˜¯å¦ç›´æ¥ä½¿ç”¨Kimi API
                if (bigDirectKimiCheckbox.checked) {
                    debugLog('ä½¿ç”¨ç›´æ¥æ¨¡å¼å¤„ç†PDF');
                    debugGroupEnd();
                    return sendDirectToKimi(pdfFile, question);
                }
                
                // åˆ›å»ºFormDataå¯¹è±¡
                const formData = new FormData();
                formData.append('pdfFile', pdfFile);
                formData.append('initialQuestion', question);
                
                debugLog('å‡†å¤‡å‘é€åˆ°æœåŠ¡å™¨', { 
                    url: `${serverUrl}/analyze-pdf`,
                    pdfName: pdfFile.name,
                    questionLength: question.length
                });
                
                // å‘é€è¯·æ±‚
                fetch(`${serverUrl}/analyze-pdf`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    debugLog('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    chatLoading.style.display = 'none';
                    debugLog('æœåŠ¡å™¨è¿”å›æ•°æ®:', data);
                    
                    if (data.error) {
                        debugLog('å¤„ç†é”™è¯¯:', data.error);
                        addSystemMessage('é”™è¯¯: ' + data.error);
                        debugGroupEnd();
                        return;
                    }
                    
                    // ä¿å­˜ä¼šè¯ID
                    sessionId = data.sessionId;
                    debugLog('ä¼šè¯å·²åˆ›å»º, ID:', sessionId);
                    
                    // æ›´æ–°ä¼šè¯çŠ¶æ€æŒ‡ç¤ºå™¨
                    updateSessionStatus();
                    
                    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ŒæŒ‡ç¤ºPDFå·²åˆ†æ
                    addSystemMessage(`PDFæ–‡ä»¶"${pdfFile.name}"å·²åˆ†æï¼Œä¸Šä¸‹æ–‡å·²ä¿å­˜åœ¨å¯¹è¯ä¸­`);
                    
                    // æ˜¾ç¤ºé—®é¢˜çš„å›ç­”
                    if (data.questionReply) {
                        debugLog('æ˜¾ç¤ºé—®é¢˜å›ç­”');
                        addMessage(data.questionReply, 'bot');
                    } else {
                        // å¦‚æœæ²¡æœ‰ç‰¹å®šé—®é¢˜çš„å›ç­”ï¼Œæ˜¾ç¤ºPDFåˆ†æç»“æœ
                        debugLog('æ˜¾ç¤ºPDFåˆ†æç»“æœ');
                        addMessage(data.result, 'bot');
                    }
                    
                    // æ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼Œä½†ä¸æ¸…é™¤PDFæ–‡ä»¶å¼•ç”¨
                    // æˆ‘ä»¬ä¿ç•™PDFæ–‡ä»¶å¼•ç”¨ï¼Œä»¥ä¾¿ç”¨æˆ·çŸ¥é“å½“å‰å¯¹è¯ä¸å“ªä¸ªPDFç›¸å…³è”
                    pdfStatus.textContent = 'PDFå·²åˆ†æï¼Œä¸Šä¸‹æ–‡å·²ä¿å­˜åœ¨å¯¹è¯ä¸­';
                    pdfStatus.style.color = '#2980b9';
                    
                    // ç¦ç”¨PDFæ–‡ä»¶è¾“å…¥ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨åŒä¸€ä¼šè¯ä¸­ä¸Šä¼ æ–°PDF
                    // å¦‚æœè¦ä¸Šä¼ æ–°PDFï¼Œéœ€è¦åˆ·æ–°é¡µé¢å¼€å§‹æ–°ä¼šè¯
                    pdfFileInput.disabled = true;
                    document.querySelector('.file-input-label').style.backgroundColor = '#95a5a6';
                    document.querySelector('.file-input-label').style.cursor = 'not-allowed';
                    
                    // æ·»åŠ ä¸€ä¸ªæ¸…é™¤PDFæŒ‰é’®ï¼Œå…è®¸ç”¨æˆ·å¼€å§‹æ–°ä¼šè¯
                    if (!document.getElementById('clearPdfBtn')) {
                        debugLog('æ·»åŠ æ¸…é™¤PDFæŒ‰é’®');
                        const clearBtn = document.createElement('button');
                        clearBtn.id = 'clearPdfBtn';
                        clearBtn.textContent = 'æ¸…é™¤PDF (å¼€å§‹æ–°ä¼šè¯)';
                        clearBtn.style.marginLeft = '10px';
                        clearBtn.style.padding = '5px 10px';
                        clearBtn.style.backgroundColor = '#e74c3c';
                        clearBtn.style.color = 'white';
                        clearBtn.style.border = 'none';
                        clearBtn.style.borderRadius = '3px';
                        clearBtn.style.cursor = 'pointer';
                        
                        clearBtn.addEventListener('click', function() {
                            debugLog('æ¸…é™¤PDFå’Œä¼šè¯');
                            // æ¸…é™¤ä¼šè¯å’ŒPDF
                            sessionId = null;
                            selectedPdfFile = null;
                            
                            // é‡ç½®UIçŠ¶æ€
                            fileNameDisplay.textContent = '';
                            pdfStatus.style.display = 'none';
                            pdfFileInput.disabled = false;
                            document.querySelector('.file-input-label').style.backgroundColor = '#3498db';
                            document.querySelector('.file-input-label').style.cursor = 'pointer';
                            
                            // æ›´æ–°ä¼šè¯çŠ¶æ€æŒ‡ç¤ºå™¨
                            updateSessionStatus();
                            
                            // ç§»é™¤æ¸…é™¤æŒ‰é’®
                            this.remove();
                            
                            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                            addSystemMessage('PDFä¸Šä¸‹æ–‡å·²æ¸…é™¤ï¼Œæ‚¨å·²å¼€å§‹æ–°ä¼šè¯');
                        });
                        
                        document.querySelector('.form-group').appendChild(clearBtn);
                    }
                    debugGroupEnd();
                })
                .catch(error => {
                    chatLoading.style.display = 'none';
                    debugLog('è¯·æ±‚é”™è¯¯:', error);
                    addSystemMessage('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message);
                    debugGroupEnd();
                });
            }
            
            // æ·»åŠ ç›´æ¥è°ƒç”¨Kimi APIçš„å‡½æ•°
            function sendDirectToKimi(pdfFile, question) {
                debugGroup('ç›´æ¥è°ƒç”¨Kimi API');
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                chatLoading.style.display = 'block';
                
                // è·å–APIå¯†é’¥
                const apiKey = document.getElementById('kimiApiKey').value.trim();
                if (!apiKey) {
                    debugLog('é”™è¯¯: ç¼ºå°‘APIå¯†é’¥');
                    addSystemMessage('é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„Kimi APIå¯†é’¥');
                    chatLoading.style.display = 'none';
                    debugGroupEnd();
                    return;
                }
                
                debugLog('PDFæ–‡ä»¶ä¿¡æ¯:', {
                    name: pdfFile.name,
                    size: pdfFile.size,
                    type: pdfFile.type,
                    lastModified: new Date(pdfFile.lastModified).toISOString()
                });
                
                // è¯»å–PDFæ–‡ä»¶
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1]; // ç§»é™¤æ•°æ®URLå‰ç¼€
                    debugLog(`PDFæ–‡ä»¶è¯»å–å®Œæˆï¼ŒBase64é•¿åº¦: ${base64Data.length}`);
                    debugLog(`Base64æ•°æ®å‰ç¼€: ${base64Data.substring(0, 30)}...`);
                    
                    // å‡†å¤‡è¯·æ±‚æ•°æ® - ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼ç›´æ¥å‘é€PDFæ–‡ä»¶
                    const requestData = {
                        model: 'moonshot-v1-32k',
                        messages: [
                            { 
                                role: 'system', 
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„PDFæ–‡æ¡£åˆ†æåŠ©æ‰‹ã€‚è¯·è¯¦ç»†åˆ†æç”¨æˆ·ä¸Šä¼ çš„PDFæ–‡ä»¶å¹¶ç›´æ¥å›ç­”ä»–ä»¬çš„é—®é¢˜ã€‚ä¸è¦è¯´ä½ ä¼šé˜…è¯»æ–‡ä»¶ï¼Œå› ä¸ºä½ å·²ç»å¯ä»¥ç›´æ¥çœ‹åˆ°æ–‡ä»¶å†…å®¹äº†ã€‚' 
                            },
                            { role: 'user', content: question || 'è¯·åˆ†æè¿™ä¸ªPDFæ–‡ä»¶' }
                        ],
                        files: [
                            {
                                data: base64Data,
                                type: 'application/pdf'
                            }
                        ]
                    };
                    
                    // è®°å½•è¯·æ±‚æ•°æ®ï¼ˆå»é™¤é•¿base64å­—ç¬¦ä¸²ï¼‰
                    logRequestResponse(requestData);
                    
                    debugLog('å‘é€è¯·æ±‚åˆ°APIç«¯ç‚¹: https://api.moonshot.cn/v1/chat/completions');
                    
                    // ç›´æ¥è°ƒç”¨Kimi API
                    fetch('https://api.moonshot.cn/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        debugLog('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        chatLoading.style.display = 'none';
                        debugLog('APIå“åº”æ•°æ®:');
                        logRequestResponse(data, 'response');
                        
                        if (data.error) {
                            debugLog('APIè¿”å›é”™è¯¯:', data.error);
                            addSystemMessage(`é”™è¯¯: ${data.error.message || data.error}`);
                            debugGroupEnd();
                            return;
                        }
                        
                        // åˆ›å»ºä¼šè¯ä¸Šä¸‹æ–‡ï¼Œä¿å­˜PDFå†…å®¹ä»¥ä¾›åç»­ä½¿ç”¨
                        if (!sessionId) {
                            sessionId = Date.now().toString();
                            
                            // ä¿å­˜PDFå†…å®¹åˆ°æœ¬åœ°ç¼“å­˜ï¼Œç”¨äºåç»­èŠå¤©
                            localStorage.setItem(`pdf_${sessionId}`, base64Data);
                            debugLog('åˆ›å»ºä¼šè¯IDå¹¶ä¿å­˜PDFåˆ°æœ¬åœ°å­˜å‚¨:', sessionId);
                        }
                        
                        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ŒæŒ‡ç¤ºPDFå·²åˆ†æ
                        addSystemMessage(`PDFæ–‡ä»¶"${pdfFile.name}"å·²ç›´æ¥é€šè¿‡Kimi APIåˆ†æ`);
                        
                        // æ˜¾ç¤ºå›ç­”
                        const reply = data.choices && data.choices[0] && data.choices[0].message ? 
                            data.choices[0].message.content : 'æ— æ³•è·å–å›ç­”';
                            
                        debugLog('AIå›å¤:', reply.length > 200 ? reply.substring(0, 200) + '...' : reply);
                        addMessage(reply, 'bot');
                        
                        // å°†æ­¤PDFä¿å­˜ä¸ºå½“å‰ä¼šè¯ä¸­çš„æ–‡ä»¶
                        selectedPdfFile = pdfFile;
                        
                        // æ›´æ–°ä¼šè¯çŠ¶æ€æŒ‡ç¤ºå™¨
                        updateSessionStatus();
                        
                        // æ›´æ–°UIçŠ¶æ€
                        pdfStatus.textContent = 'PDFå·²é€šè¿‡Kimi APIåˆ†æï¼Œæ‚¨å¯ä»¥ç»§ç»­æé—®';
                        pdfStatus.style.color = '#2980b9';
                        pdfStatus.style.display = 'block';
                        debugGroupEnd();
                    })
                    .catch(error => {
                        chatLoading.style.display = 'none';
                        debugLog('APIè°ƒç”¨å¼‚å¸¸:', error);
                        addSystemMessage(`ç›´æ¥è°ƒç”¨Kimi APIå¤±è´¥: ${error.message}`);
                        debugGroupEnd();
                    });
                };
                
                reader.onerror = function(error) {
                    chatLoading.style.display = 'none';
                    debugLog('PDFæ–‡ä»¶è¯»å–é”™è¯¯:', error);
                    addSystemMessage('é”™è¯¯: æ— æ³•è¯»å–PDFæ–‡ä»¶');
                    debugGroupEnd();
                };
                
                // å¼€å§‹è¯»å–æ–‡ä»¶
                debugLog('å¼€å§‹è¯»å–PDFæ–‡ä»¶...');
                reader.readAsDataURL(pdfFile);
            }
            
            // ä¿®æ”¹èŠå¤©æ¶ˆæ¯å‘é€å‡½æ•°
            const originalSendChatMessage = sendChatMessage;
            sendChatMessage = function(message) {
                debugGroup('å‘é€èŠå¤©æ¶ˆæ¯');
                debugLog('æ¶ˆæ¯:', message);
                debugLog('ä¼šè¯çŠ¶æ€:', { 
                    hasSession: !!sessionId, 
                    hasPdf: !!selectedPdfFile, 
                    directMode: bigDirectKimiCheckbox.checked 
                });
                
                // æ£€æŸ¥æ˜¯å¦ç›´æ¥ä½¿ç”¨Kimi API
                if (bigDirectKimiCheckbox.checked && selectedPdfFile) {
                    debugLog('ä½¿ç”¨ç›´æ¥æ¨¡å¼å‘é€æ¶ˆæ¯ï¼ŒåŒ…å«PDF');
                    debugGroupEnd();
                    sendDirectToKimi(selectedPdfFile, message);
                    return;
                } else if (bigDirectKimiCheckbox.checked && sessionId) {
                    // å¦‚æœä¹‹å‰ä¸Šä¼ è¿‡PDFå¹¶ä¸”ä½¿ç”¨ç›´è¿æ¨¡å¼ï¼Œæ£€æŸ¥æœ¬åœ°ç¼“å­˜ä¸­æ˜¯å¦æœ‰PDFå†…å®¹
                    const savedPdf = localStorage.getItem(`pdf_${sessionId}`);
                    
                    if (savedPdf) {
                        debugLog('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„PDFå‘é€æ¶ˆæ¯');
                        
                        // æ˜¾ç¤ºåŠ è½½ä¸­
                        chatLoading.style.display = 'block';
                        
                        // è·å–APIå¯†é’¥
                        const apiKey = document.getElementById('kimiApiKey').value.trim();
                        if (!apiKey) {
                            debugLog('é”™è¯¯: ç¼ºå°‘APIå¯†é’¥');
                            addSystemMessage('é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„Kimi APIå¯†é’¥');
                            chatLoading.style.display = 'none';
                            debugGroupEnd();
                            return;
                        }
                        
                        // å‡†å¤‡è¯·æ±‚æ•°æ® - ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„PDF
                        const requestData = {
                            model: 'moonshot-v1-32k',
                            messages: [
                                { 
                                    role: 'system', 
                                    content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„PDFæ–‡æ¡£åˆ†æåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¹‹å‰ä¸Šä¼ çš„PDFæ–‡ä»¶å†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜ã€‚ä¸è¦è¯´ä½ ä¼šé˜…è¯»æ–‡ä»¶ï¼Œå› ä¸ºä½ å·²ç»å¯ä»¥ç›´æ¥çœ‹åˆ°æ–‡ä»¶å†…å®¹äº†ã€‚' 
                                },
                                { role: 'user', content: message }
                            ],
                            files: [
                                {
                                    data: savedPdf,
                                    type: 'application/pdf'
                                }
                            ]
                        };
                        
                        // è®°å½•è¯·æ±‚æ•°æ®ï¼ˆå»é™¤é•¿base64å­—ç¬¦ä¸²ï¼‰
                        logRequestResponse(requestData);
                        
                        debugLog('ä½¿ç”¨ç¼“å­˜PDFå‘é€è¯·æ±‚åˆ°APIç«¯ç‚¹');
                        
                        // ç›´æ¥è°ƒç”¨Kimi API
                        fetch('https://api.moonshot.cn/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify(requestData)
                        })
                        .then(response => {
                            debugLog('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                            return response.json();
                        })
                        .then(data => {
                            chatLoading.style.display = 'none';
                            debugLog('APIå“åº”æ•°æ®:');
                            logRequestResponse(data, 'response');
                            
                            if (data.error) {
                                debugLog('APIè¿”å›é”™è¯¯:', data.error);
                                addSystemMessage(`é”™è¯¯: ${data.error.message || data.error}`);
                                debugGroupEnd();
                                return;
                            }
                            
                            // æ˜¾ç¤ºå›ç­”
                            const reply = data.choices && data.choices[0] && data.choices[0].message ? 
                                data.choices[0].message.content : 'æ— æ³•è·å–å›ç­”';
                                
                            debugLog('AIå›å¤:', reply.length > 200 ? reply.substring(0, 200) + '...' : reply);
                            addMessage(reply, 'bot');
                            debugGroupEnd();
                        })
                        .catch(error => {
                            chatLoading.style.display = 'none';
                            debugLog('APIè°ƒç”¨å¼‚å¸¸:', error);
                            addSystemMessage(`ç›´æ¥è°ƒç”¨Kimi APIå¤±è´¥: ${error.message}`);
                            debugGroupEnd();
                        });
                        
                        return;
                    }
                }
                
                // å¦‚æœç›´æ¥ä½¿ç”¨Kimi APIä¸”æ²¡æœ‰PDFæ–‡ä»¶
                if (bigDirectKimiCheckbox.checked) {
                    debugLog('ç›´æ¥æ¨¡å¼ï¼Œæ— PDFï¼Œå‘é€æ™®é€šèŠå¤©');
                    
                    // æ˜¾ç¤ºåŠ è½½ä¸­
                    chatLoading.style.display = 'block';
                    
                    // è·å–APIå¯†é’¥
                    const apiKey = document.getElementById('kimiApiKey').value.trim();
                    if (!apiKey) {
                        debugLog('é”™è¯¯: ç¼ºå°‘APIå¯†é’¥');
                        addSystemMessage('é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„Kimi APIå¯†é’¥');
                        chatLoading.style.display = 'none';
                        debugGroupEnd();
                        return;
                    }
                    
                    // å‡†å¤‡è¯·æ±‚æ•°æ®
                    const requestData = {
                        model: 'moonshot-v1-8k',
                        messages: [
                            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„PDFæ–‡æ¡£åˆ†æåŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”å…³äºPDFæ–‡ä»¶çš„ä¸€èˆ¬æ€§é—®é¢˜ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹ä¸Šä¼ çš„PDFæä¾›è¯¦ç»†åˆ†æã€‚å½“ç”¨æˆ·æ²¡æœ‰ä¸Šä¼ PDFæ–‡ä»¶æ—¶ï¼Œè¯·ç›´æ¥å›ç­”ä»–ä»¬çš„é—®é¢˜ï¼Œä¸è¦è¦æ±‚ä»–ä»¬ä¸Šä¼ PDFã€‚' },
                            { role: 'user', content: message }
                        ]
                    };
                    
                    debugLog('è¯·æ±‚æ•°æ®:', requestData);
                    
                    // ç›´æ¥è°ƒç”¨Kimi API
                    fetch('https://api.moonshot.cn/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        debugLog('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        chatLoading.style.display = 'none';
                        debugLog('APIå“åº”æ•°æ®:', data);
                        
                        if (data.error) {
                            debugLog('APIè¿”å›é”™è¯¯:', data.error);
                            addSystemMessage(`é”™è¯¯: ${data.error.message || data.error}`);
                            debugGroupEnd();
                            return;
                        }
                        
                        // æ˜¾ç¤ºå›ç­”
                        const reply = data.choices && data.choices[0] && data.choices[0].message ? 
                            data.choices[0].message.content : 'æ— æ³•è·å–å›ç­”';
                            
                        debugLog('AIå›å¤:', reply.length > 200 ? reply.substring(0, 200) + '...' : reply);
                        addMessage(reply, 'bot');
                        debugGroupEnd();
                    })
                    .catch(error => {
                        chatLoading.style.display = 'none';
                        debugLog('APIè°ƒç”¨å¼‚å¸¸:', error);
                        addSystemMessage(`ç›´æ¥è°ƒç”¨Kimi APIå¤±è´¥: ${error.message}`);
                        debugGroupEnd();
                    });
                    
                    return;
                }
                
                debugLog('ä½¿ç”¨æœåŠ¡å™¨æ¨¡å¼å‘é€æ¶ˆæ¯');
                // åŸæœ‰çš„é€šè¿‡æœåŠ¡å™¨å‘é€é€»è¾‘
                if (typeof originalSendChatMessage === 'function') {
                    originalSendChatMessage(message);
                } else {
                    debugLog('é”™è¯¯: åŸå§‹sendChatMessageå‡½æ•°æœªå®šä¹‰');
                    chatLoading.style.display = 'none';
                    addSystemMessage('é”™è¯¯: æ¶ˆæ¯å‘é€åŠŸèƒ½æœªæ­£ç¡®åˆå§‹åŒ–');
                }
                debugGroupEnd();
            };
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                
                // å¤„ç†Markdownä¸­çš„æ¢è¡Œç¬¦ï¼Œå°†\næ›¿æ¢ä¸º<br>æ ‡ç­¾
                bubble.innerHTML = text.replace(/\n/g, '<br>');
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            function addSystemMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.style.backgroundColor = '#f8f9fa';
                bubble.style.fontStyle = 'italic';
                
                // å¤„ç†Markdownä¸­çš„æ¢è¡Œç¬¦ï¼Œå°†\næ›¿æ¢ä¸º<br>æ ‡ç­¾
                bubble.innerHTML = text.replace(/\n/g, '<br>');
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html> 